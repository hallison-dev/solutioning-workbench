<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solutioning Workbench: Solutioning Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Typography & Base */
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
        html { scroll-behavior: smooth; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Components */
        .badge { display: inline-flex; align-items: center; padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .badge-blue { background-color: #eff6ff; color: #1d4ed8; border: 1px solid #dbeafe; }
        .badge-amber { background-color: #fffbeb; color: #b45309; border: 1px solid #fcd34d; }
        .badge-green { background-color: #d1fae5; color: #047857; border: 1px solid #a7f3d0; }
        .badge-purple { background-color: #f3e8ff; color: #7e22ce; border: 1px solid #d8b4fe; }
        .badge-red { background-color: #fef2f2; color: #b91c1c; border: 1px solid #fecaca; }
        .badge-indigo { background-color: #e0e7ff; color: #4338ca; border: 1px solid #c7d2fe; }
        .badge-slate { background-color: #f1f5f9; color: #475569; border: 1px solid #cbd5e1; }
        .badge-emerald { background-color: #ecfdf5; color: #047857; border: 1px solid #a7f3d0; }
        
        /* Row ID Badge */
        .row-id-badge { font-size: 0.65rem; font-family: 'Courier New', monospace; background: #f8fafc; color: #64748b; padding: 2px 6px; border-radius: 4px; margin-right: 8px; border: 1px solid #e2e8f0; vertical-align: middle; }

        /* Navigation */
        .nav-item.active { background-color: #1e293b; border-left: 4px solid #3b82f6; color: white; }
        .nav-item { border-left: 4px solid transparent; color: #94a3b8; }
        .tab-btn.active { background-color: #2563eb; color: white; border-color: #2563eb; }
        .tab-btn { background-color: white; color: #64748b; border: 1px solid #cbd5e1; }

        /* Status badges */
        .status-badge { display: inline-block; padding: 4px 8px; border-radius: 9999px; font-weight: 700; text-transform: lowercase; font-size: 0.75rem; cursor: pointer; user-select: none; }
        .status-badge.mapped { background: #dcfce7; color: #065f46; border: 1px solid #86efac; }
        .status-badge.pending { background: #fff7ed; color: #9a3412; border: 1px solid #fdba74; }
        .status-badge.gap { background: #fef2f2; color: #991b1b; border: 1px solid #fca5a5; }

        /* Category tag */
        .tag-badge { display: inline-block; margin-left: 8px; padding: 2px 8px; border-radius: 9999px; background: #f1f5f9; color: #0f172a; font-size: 0.7rem; font-weight: 600; }
        .category-select { font-size: 0.7rem; padding: 3px 6px; border: 1px solid #e2e8f0; border-radius: 6px; background: white; }

        /* Toast */
        #toast-container { position: fixed; right: 24px; bottom: 24px; z-index: 99999; display: flex; flex-direction: column; gap: 8px; }
        .toast { min-width: 220px; padding: 10px 14px; border-radius: 8px; color: white; font-weight: 600; box-shadow: 0 6px 18px rgba(2,6,23,0.2); opacity: 0; transform: translateY(8px); transition: all 220ms ease; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { background: #059669; }
        .toast.info { background: #2563eb; }
        .toast.warn { background: #d97706; }
        .toast.error { background: #b91c1c; }

        /* Story Feed */
        .feed-item { position: relative; padding-left: 1.5rem; padding-bottom: 1.5rem; border-left: 2px solid #e2e8f0; transition: all 0.3s ease; opacity: 0.5; cursor: pointer; }
        .feed-item.active { opacity: 1; border-left-color: #3b82f6; }
        .feed-item:last-child { border-left-color: transparent; }
        .feed-dot { position: absolute; left: -7px; top: 0; width: 12px; height: 12px; border-radius: 50%; background-color: #cbd5e1; transition: all 0.3s ease; }
        .feed-item.active .feed-dot { background-color: #3b82f6; transform: scale(1.2); box-shadow: 0 0 0 4px #dbeafe; }

        /* Feed Hover Modal */
        .feed-modal { display: none; position: absolute; right: 100%; top: 0; width: 280px; margin-right: 20px; background: white; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); z-index: 9999; text-align: left; pointer-events: none; }
        .feed-modal::after { content: ''; position: absolute; right: -6px; top: 12px; width: 12px; height: 12px; background: white; transform: rotate(45deg); border-right: 1px solid #e2e8f0; border-top: 1px solid #e2e8f0; }
        .feed-container.show-modals .feed-item:hover .feed-modal { display: block; animation: fadeIn 0.2s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateX(10px); } to { opacity: 1; transform: translateX(0); } }

        /* Question Builder */
        .question-row { transition: all 0.3s ease; }
        .question-row.confirmed { background-color: #f0fdf4; border-color: #bbf7d0; }
        .question-row.confirmed .q-text { color: #15803d; text-decoration: line-through; text-decoration-color: #86efac; }
        .answer-box { display: none; }
        .answer-box.visible { display: block; animation: slideDown 0.2s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Interactive Hints */
        .hint-box { display: none; }
        .hint-trigger:hover + .hint-box { display: block; }

        /* Spec Uploader Styles */
        .uploader-modal { position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .uploader-modal.hidden { display: none; }
        .row-item { cursor: grab; }
        .row-item:active { cursor: grabbing; }
        .drag-zone { transition: all 0.2s ease; }
        .drag-zone.drag-over { background-color: #eff6ff; border-color: #3b82f6; }
        
        /* Master Spec */
        .spec-key { max-width: 420px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: inline-block; vertical-align: middle; }
        .spec-key:hover { cursor: help; }
        .spec-key.wrap { white-space: normal; word-break: break-word; max-width: none; }
        /* master spec search & attach widgets */
        .master-search { width: 100%; max-width: 480px; padding: 8px 10px; border: 1px solid #e6eef8; border-radius: 8px; }
        .attach-widget { position: relative; display: inline-block; }
        .attach-input { width: 260px; padding: 6px 8px; border: 1px solid #e6eef8; border-radius: 6px; }
        .attach-list { position: absolute; top: 36px; left: 0; right: 0; max-height: 180px; overflow-y: auto; background: white; border: 1px solid #e6eef8; box-shadow: 0 8px 18px rgba(2,6,23,0.06); z-index: 60; }
        .attach-item { padding: 6px 8px; font-size: 13px; cursor: pointer; }
        .attach-item:hover { background: #f1f5f9; }
        .spec-action { margin-left: 8px; font-size: 12px; color: #2563eb; cursor: pointer; }
        .unassign-mark { background: #fff7f5; border-color: #fecaca !important; } .unassign-mark td { color: #9f1239; }

        /* Autocomplete Styles */
        .autocomplete-wrapper { position: relative; width: 100%; }
        .autocomplete-list { position: absolute; top: 100%; left: 0; right: 0; max-height: 220px; overflow-y: auto; background: white; border: 1px solid #cbd5e1; border-radius: 0 0 6px 6px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); z-index: 50; display: none; }
        .autocomplete-item { padding: 8px 12px; font-size: 0.8rem; cursor: pointer; border-bottom: 1px solid #f1f5f9; }
        .autocomplete-item:last-child { border-bottom: none; }
        .autocomplete-item:hover { background-color: #eff6ff; color: #1d4ed8; }
        .autocomplete-item strong { color: #1e40af; font-family: 'Courier New', monospace; font-weight: bold; }
        .autocomplete-desc { display: block; font-size: 0.7rem; color: #64748b; margin-top: 2px; }

        /* Highlight Flash Animation for Gaps Deep-Link */
        @keyframes highlight-row { 0% { background: #fef9c3; } 100% { background: transparent; } }
        .highlight-flash { animation: highlight-row 2s ease-out; }

        /* Toggle Mode Styles */
        .mode-toggle-btn { transition: all 0.3s; }
        
        /* Visualizer */
        .check-face { background-image: radial-gradient(#e2e8f0 1px, transparent 1px); background-size: 10px 10px; font-family: 'Georgia', serif; }
        .check-field { position: relative; cursor: help; border: 1px dashed transparent; transition: all 0.2s; }
        .check-field:hover { border-color: #3b82f6; background-color: rgba(59, 130, 246, 0.1); }
        .check-field::after { content: attr(data-tooltip); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background-color: #1e293b; color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; white-space: nowrap; opacity: 0; pointer-events: none; transition: opacity 0.2s; z-index: 50; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .check-field:hover::after { opacity: 1; bottom: 110%; }
    </style>
</head>
<body class="bg-stone-50 text-slate-800 h-screen flex overflow-hidden">

    <aside class="w-64 bg-slate-900 flex-shrink-0 flex flex-col h-full shadow-xl z-20 hidden md:flex">
        <div class="p-6 border-b border-slate-800">
            <h1 class="text-white font-bold text-lg tracking-tight">Solutioning Workbench <span class="text-blue-500 text-xs uppercase align-top">Beta</span></h1>
            <p class="text-slate-400 text-xs mt-1">Solutioning Builder v3.6</p>
        </div>
        
        <nav class="flex-1 overflow-y-auto py-6 space-y-1" id="main-nav">
            </nav>

        <div class="p-4 border-t border-slate-800">
            <div class="bg-slate-800 rounded p-3 flex items-center">
                <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white font-bold text-xs">SE</div>
                <div class="ml-3">
                    <p class="text-white text-sm font-medium">Hakeem A.</p>
                    <p class="text-slate-400 text-xs">Solutions Engineer</p>
                </div>
            </div>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto relative scroll-smooth p-8 md:p-12 space-y-24" id="main-scroll">
        
        <div class="max-w-4xl mx-auto">
            <div class="flex justify-between items-end mb-12 border-b border-slate-200 pb-6">
                <div>
                    <h2 class="text-3xl font-extrabold text-slate-900">Check Print Solutioning</h2>
                    <p class="text-slate-500 mt-2">Target: <strong class="text-slate-800">Customers Bank</strong> | Spec: <span class="badge badge-blue">Flat File (CSV)</span></p>
                </div>
                <div class="flex flex-col items-end gap-3">
                    <div class="flex items-center bg-slate-100 rounded-lg p-1 border border-slate-200">
                        <button onclick="switchMode('enrichment')" id="btn-mode-enrichment" class="mode-toggle-btn px-3 py-1.5 rounded-md text-xs font-bold text-slate-500">Data Enrichment</button>
                        <button onclick="switchMode('logical')" id="btn-mode-logical" class="mode-toggle-btn px-3 py-1.5 rounded-md text-xs font-bold text-slate-500">Logical Story</button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="toggleUploader()" class="bg-white border border-slate-300 text-blue-600 px-3 py-2 rounded-lg text-xs font-semibold shadow-sm hover:bg-blue-50 flex items-center">
                            <span class="mr-2">üìÇ</span> Open Modal
                        </button>
                        <button onclick="toggleExport()" class="bg-blue-600 text-white px-3 py-2 rounded-lg text-xs font-semibold shadow-sm hover:bg-blue-700 flex items-center">
                            <span class="mr-2">üì§</span> Export Doc
                        </button>
                        <button onclick="saveNow()" class="bg-emerald-600 text-white px-3 py-2 rounded-lg text-xs font-semibold shadow-sm hover:bg-emerald-700">Save</button>
                        <button onclick="resetState()" class="bg-red-100 text-red-700 px-3 py-2 rounded-lg text-xs font-semibold shadow-sm hover:bg-red-200">Reset</button>
                    </div>
                </div>
            </div>

            <section id="spec-manager" class="scroll-mt-24 group">
                <div class="bg-white p-6 rounded-xl border border-blue-100 shadow-sm relative ring-1 ring-blue-50">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-slate-900 flex items-center">
                            <span class="bg-blue-100 text-blue-600 p-1 rounded mr-2 text-sm">üì§</span> 
                            Specification Manager
                        </h3>
                        <span class="text-xs text-slate-400">Assign raw spec rows to solution phases</span>
                    </div>
                    
                    <div class="flex flex-col md:flex-row gap-6">
                        <div class="flex-1 border-2 border-dashed border-slate-300 rounded-lg p-6 text-center hover:bg-slate-50 transition cursor-pointer bg-slate-50/50 drag-zone" id="drag-zone">
                            <div class="text-3xl mb-2">üìÑ</div>
                            <p class="text-sm font-medium text-slate-700">Standard Check Layout.csv</p>
                            <p class="text-xs text-emerald-600 font-bold mt-1">‚úì Ready</p>
                        </div>

                        <div class="flex-1">
                            <h4 class="text-xs font-bold text-slate-500 uppercase mb-2">Unassigned Rows (Staging)</h4>
                            <div id="unassigned-staging" class="border border-slate-200 rounded-lg h-64 overflow-y-auto bg-white p-2 space-y-2 shadow-inner">
                                <p class="text-xs text-slate-500 p-3">No unassigned rows.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="phase-1" class="scroll-mt-24 group" data-index="0">
                <div class="flex items-center mb-6">
                    <span class="bg-blue-100 text-blue-700 font-bold px-3 py-1 rounded text-sm mr-3">PHASE 1</span>
                    <h3 class="text-2xl font-bold text-slate-900">Connectivity & Security</h3>
                </div>
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm relative">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="p-4 border rounded-lg hover:border-blue-300 transition relative group/card">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-bold text-slate-800">üì° Transport Protocol</h4>
                                <span class="text-slate-400 cursor-help hint-trigger">‚ÑπÔ∏è</span>
                                <div class="hint-box absolute right-4 top-10 w-64 bg-slate-800 text-white text-xs p-3 rounded shadow-xl z-20">
                                    <strong>Solution Mapping Context:</strong><br> SFTP: Faster implementation.<br> API: Real-time but complex.
                                </div>
                            </div>
                            <div class="space-y-2">
                                <label class="flex items-center space-x-2 p-2 rounded hover:bg-slate-50 cursor-pointer"><input type="radio" name="transport" class="text-blue-600" checked onchange="updateContext('sftp')"><span class="text-sm font-medium">SFTP (File Based)</span></label>
                                <label class="flex items-center space-x-2 p-2 rounded hover:bg-slate-50 cursor-pointer"><input type="radio" name="transport" class="text-blue-600" onchange="updateContext('api')"><span class="text-sm font-medium">API (Real-Time)</span></label>
                            </div>
                        </div>
                        <div class="p-4 border rounded-lg hover:border-blue-300 transition">
                            <h4 class="font-bold text-slate-800 mb-2">üîë Credential Scope</h4>
                            <div class="space-y-2">
                                <label class="flex items-center space-x-2"><input type="radio" name="scope" class="text-blue-600"><span class="text-sm">Gateway Level</span></label>
                                <label class="flex items-center space-x-2"><input type="radio" name="scope" class="text-blue-600" checked><span class="text-sm">Client Level</span></label>
                            </div>
                        </div>
                    </div>
                    <div id="dynamic-context" class="mb-6 p-3 bg-blue-50 border border-blue-200 rounded text-sm text-blue-800 flex items-start">
                        <span class="mr-2">üí°</span><p><strong>Nudge:</strong> Since SFTP is selected, suggest PGP Encryption for security compliance.</p>
                    </div>
                    <div class="pt-6 border-t border-slate-100 bg-slate-50/50 -mx-6 -mb-6 px-6 pb-6 rounded-b-xl">
                        <div class="space-y-3" id="q-phase-1"></div>
                        <div class="mt-3 relative inline-block text-left w-full">
                            <button onclick="toggleDropdown('dd-phase-1')" class="flex items-center text-xs font-bold text-blue-600 hover:text-blue-800 transition bg-white border border-blue-200 px-3 py-2 rounded-lg shadow-sm w-full justify-between"><span>+ Add Scoping Question</span><span>‚ñº</span></button>
                            <div id="dd-phase-1" class="hidden absolute left-0 mt-2 w-full bg-white border border-slate-200 rounded-md shadow-lg z-50"><div class="py-1">
                                <button onclick="addPresetQuestion('q-phase-1', 'Does the SFTP server require IP Allowlisting?')" class="block px-4 py-2 text-sm text-slate-700 hover:bg-blue-50 w-full text-left">IP Allowlisting?</button>
                                <button onclick="addCustomQuestion('q-phase-1')" class="block px-4 py-2 text-sm text-blue-600 font-bold hover:bg-blue-50 w-full text-left border-t">Write Custom Question...</button>
                            </div></div>
                        </div>
                        <div class="mt-4 border-t border-slate-200 pt-2">
                             <button onclick="addNote('q-phase-1')" class="text-xs text-slate-400 hover:text-slate-600 flex items-center"><span class="mr-1">+</span> Add Note</button>
                        </div>
                    </div>
                </div>
            </section>

            <div id="dynamic-workbench-container">
                </div>

            <section id="phase-4" class="scroll-mt-24 pt-12 border-t border-dashed border-slate-200 mt-12 pb-24 group" data-index="4">
                <div class="flex items-center mb-6">
                    <span class="bg-emerald-100 text-emerald-700 font-bold px-3 py-1 rounded text-sm mr-3">PHASE 4</span>
                    <h3 class="text-2xl font-bold text-slate-900">Bank Specification (Master List)</h3>
                </div>
                
                <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                    <div class="bg-slate-50 border-b border-slate-200 px-6 py-4 flex flex-wrap gap-2">
                        <button onclick="switchTab('summary')" id="btn-summary" class="tab-btn active px-4 py-2 rounded-lg text-sm font-bold transition shadow-sm">‚ö†Ô∏è Gaps</button>
                        <button onclick="switchTab('full')" id="btn-full" class="tab-btn px-4 py-2 rounded-lg text-sm font-bold transition shadow-sm">üìÑ Master Spec</button>
                        <button onclick="switchTab('visualizer')" id="btn-visualizer" class="tab-btn px-4 py-2 rounded-lg text-sm font-bold transition shadow-sm border-blue-200 text-blue-700 bg-blue-50">üñ®Ô∏è Visualizer</button>
                        <button onclick="switchTab('tags')" id="btn-tags" class="tab-btn px-4 py-2 rounded-lg text-sm font-bold transition shadow-sm">üè∑Ô∏è Tags</button>
                    </div>
                    
                    <div class="p-6">
                        <div id="view-summary" class="block">
                            <div class="bg-amber-50 border-l-4 border-amber-400 p-4 mb-4"><h4 class="font-bold text-amber-900 text-sm">Automated Gaps Detected</h4></div>
                            <div id="gaps-list" class="text-sm">
                                <p class="text-xs text-slate-500">No gaps detected yet.</p>
                            </div>
                        </div>
                        <div id="view-full" class="hidden">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-3">
                                    <input id="master-search" class="master-search" placeholder="Search FISPAN constant..." />
                                    <button id="master-toggle-wrap" class="text-sm px-3 py-1 border rounded text-slate-600">Wrap: <span id="master-wrap-state">off</span></button>
                                </div>
                                <div class="text-sm text-slate-500 ml-4">Total: <span id="master-count">0</span></div>
                            </div>
                            <table class="w-full text-left text-sm border-collapse">
                                <thead class="bg-slate-50 text-slate-700 font-bold">
                                    <tr>
                                        <th class="p-3 border-b bg-slate-100 w-1/3">FISPAN Constant</th>
                                        <th class="p-3 border-b bg-slate-100 w-1/6">Value Type</th>
                                        <th class="p-3 border-b bg-slate-100">Mapped Spec</th>
                                        <th class="p-3 border-b bg-slate-100">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="full-spec-body" class="divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                        <div id="view-visualizer" class="hidden">
                             <div class="check-face relative bg-blue-50 border-2 border-slate-300 rounded-md p-6 w-full max-w-3xl mx-auto shadow-md mb-6" style="aspect-ratio: 2.5/1;">
                                <div class="absolute top-6 left-6 text-xs check-field" data-tooltip="Row 23: Payer Name"><p class="font-bold">MYCOMPANY INC.</p></div>
                                <div class="absolute top-1/3 left-6 right-12 mt-6 flex items-end">
                                    <span class="text-xs font-bold uppercase mr-2">Pay To:</span>
                                    <div class="border-b border-slate-400 flex-grow pl-2 font-bold text-lg check-field" data-tooltip="Row 14: Payee Name">ACME CORP</div>
                                    <div class="ml-4 border border-slate-300 bg-white px-2 py-1 font-bold text-lg check-field" data-tooltip="Row 38: Amount">$500.00</div>
                                </div>
                                <div class="absolute top-6 left-1/2 transform -translate-x-1/2 text-center text-[10px] text-slate-400 check-field" data-tooltip="Row 33: Bank Name">CUSTOMERS BANK</div>
                            </div>
                            <div class="max-w-3xl mx-auto border-t border-slate-200 pt-4">
                                <h5 class="text-xs font-bold text-slate-500 uppercase mb-3">üìÅ Logic Data (Not Printed)</h5>
                                <div class="grid grid-cols-3 gap-3 text-xs">
                                    <div class="p-2 bg-slate-50 border rounded check-field" data-tooltip="Row 45: Delivery">Method: Mail</div>
                                </div>
                            </div>
                        </div>
                        <div id="view-tags" class="hidden">
                            <p class="text-xs text-slate-500">No assigned rows yet.</p>
                        </div>
                    </div>

                    <div class="pt-6 border-t border-slate-100 bg-slate-50/50 px-6 pb-6">
                        <div class="space-y-3" id="q-phase-4"></div>
                        <div class="mt-3 relative inline-block text-left w-full">
                            <button onclick="toggleDropdown('dd-phase-4')" class="flex items-center text-xs font-bold text-blue-600 hover:text-blue-800 transition bg-white border border-blue-200 px-3 py-2 rounded-lg shadow-sm w-full justify-between"><span>+ Add Scoping Question</span><span>‚ñº</span></button>
                            <div id="dd-phase-4" class="hidden absolute bottom-full mb-2 left-0 w-full bg-white border border-slate-200 rounded-md shadow-lg z-50"><div class="py-1"><button onclick="addCustomQuestion('q-phase-4')" class="block px-4 py-2 text-sm text-blue-600 font-bold hover:bg-blue-50 w-full text-left border-t">Write Custom Question...</button></div></div>
                        </div>
                        <div class="mt-4 border-t border-slate-200 pt-2">
                             <button onclick="addNote('q-phase-4')" class="text-xs text-slate-400 hover:text-slate-600 flex items-center"><span class="mr-1">+</span> Add Note</button>
                        </div>
                    </div>
                </div>
            </section>

        </div>
    </main>

    <aside class="w-80 bg-white border-l border-slate-200 flex-shrink-0 hidden xl:flex flex-col h-full shadow-lg z-30">
        <div class="p-6 border-b border-slate-100 flex justify-between items-center">
            <div>
                <h3 class="font-bold text-slate-800">Lifecycle Feed</h3>
                <p class="text-xs text-slate-500 mt-1">Granular Transaction Steps</p>
            </div>
            <label class="flex items-center cursor-pointer relative" title="Toggle Technical Context">
                <input type="checkbox" id="toggle-feed-context" class="sr-only">
                <div class="w-8 h-4 bg-slate-200 rounded-full shadow-inner"></div>
                <div class="dot absolute left-0 top-0 w-4 h-4 bg-white rounded-full shadow transition-transform duration-300"></div>
            </label>
        </div>
        <div class="flex-1 overflow-y-auto p-6 space-y-0 relative feed-container" id="feed-container">
            <div class="feed-item" data-phase="2">
                <div class="feed-dot"></div>
                <h4 class="text-sm font-bold text-slate-800">User Accesses Plugin</h4>
                <p class="text-xs text-slate-500 mt-1">Requests latest open bills from ERP GL.</p>
                <div class="feed-modal"><h5 class="font-bold text-xs text-blue-700 uppercase mb-2">Technical Context</h5><p class="text-xs text-slate-600 leading-relaxed">Plugin initiates `GET /vendor-bills` call to ERP API.</p></div>
            </div>
            <div class="feed-item" data-phase="2">
                <div class="feed-dot"></div>
                <h4 class="text-sm font-bold text-slate-800">Method Selection</h4>
                <p class="text-xs text-slate-500 mt-1">User selects "Check" via Dropdown.</p>
                <div class="feed-modal"><h5 class="font-bold text-xs text-blue-700 uppercase mb-2">Configuration</h5><p class="text-xs text-slate-600 leading-relaxed">Mapped to Bank Code: `CHK`.</p></div>
            </div>
             <div class="feed-item" data-phase="2">
                <div class="feed-dot"></div>
                <h4 class="text-sm font-bold text-slate-800">Submission & Auth</h4>
                <p class="text-xs text-slate-500 mt-1">Plugin creates record. FISPAN authenticates.</p>
            </div>
            <div class="feed-item" data-phase="3">
                <div class="feed-dot"></div>
                <h4 class="text-sm font-bold text-slate-800">Platform Validation</h4>
                <p class="text-xs text-slate-500 mt-1">Checks data against Customer File Spec.</p>
            </div>
            <div class="feed-item" data-phase="3">
                <div class="feed-dot"></div>
                <h4 class="text-sm font-bold text-slate-800">Transformation</h4>
                <p class="text-xs text-slate-500 mt-1">Formats valid requests into Bank CSV.</p>
            </div>
             <div class="feed-item" data-phase="3">
                <div class="feed-dot"></div>
                <h4 class="text-sm font-bold text-slate-800">Transmission</h4>
                <p class="text-xs text-slate-500 mt-1">Sends to Endpoint (SFTP/API).</p>
            </div>
             <div class="feed-item" data-phase="4">
                <div class="feed-dot"></div>
                <h4 class="text-sm font-bold text-slate-800">Bank Processing</h4>
                <p class="text-xs text-slate-500 mt-1">Bank parses file & executes payments.</p>
            </div>
             <div class="feed-item" data-phase="4">
                <div class="feed-dot"></div>
                <h4 class="text-sm font-bold text-slate-800">Status Updates</h4>
                <p class="text-xs text-slate-500 mt-1">Bank sends webhooks/ACKs back to FISPAN.</p>
                <div class="feed-modal"><h5 class="font-bold text-xs text-blue-700 uppercase mb-2">Webhook Payload</h5><p class="text-xs text-slate-600 leading-relaxed">Example payload: <code class="font-mono">{ paymentId, status, bankRef, errorCode }</code></p></div>
            </div>
            <div class="feed-item" data-phase="4">
                <div class="feed-dot"></div>
                <h4 class="text-sm font-bold text-slate-800">Reconciliation</h4>
                <p class="text-xs text-slate-500 mt-1">Bank feeds reconcile transactions in ERP.</p>
                <div class="feed-modal"><h5 class="font-bold text-xs text-blue-700 uppercase mb-2">Reconciliation Data</h5><p class="text-xs text-slate-600 leading-relaxed">Includes bank statement lines, settlement references.</p></div>
            </div>
        </div>
    </aside>

    <div id="export-modal" class="uploader-modal hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-8 relative">
            <button onclick="toggleExport()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">‚úï</button>
            <h3 class="text-xl font-bold text-slate-900 mb-2">Export Solution</h3>
            <p class="text-sm text-slate-500 mb-6">Choose an export format for your current mapping configuration.</p>
            
            <div class="space-y-4">
                <div class="p-4 border rounded-lg hover:bg-slate-50 cursor-pointer flex items-center justify-between group" onclick="copyToClipboardHTML()">
                    <div class="flex items-center gap-3">
                        <div class="bg-blue-100 text-blue-600 w-10 h-10 rounded-full flex items-center justify-center text-xl">üìã</div>
                        <div>
                            <h4 class="font-bold text-slate-800">Copy to Clipboard</h4>
                            <p class="text-xs text-slate-500">Best for pasting into Confluence, Excel, or Google Sheets.</p>
                        </div>
                    </div>
                    <span class="text-blue-600 opacity-0 group-hover:opacity-100 transition font-bold text-sm">Copy &rarr;</span>
                </div>

                <div class="p-4 border rounded-lg hover:bg-slate-50 cursor-pointer flex items-center justify-between group" onclick="downloadCSV()">
                    <div class="flex items-center gap-3">
                        <div class="bg-emerald-100 text-emerald-600 w-10 h-10 rounded-full flex items-center justify-center text-xl">üìä</div>
                        <div>
                            <h4 class="font-bold text-slate-800">Download CSV</h4>
                            <p class="text-xs text-slate-500">Raw data file for data analysis or migration.</p>
                        </div>
                    </div>
                    <span class="text-emerald-600 opacity-0 group-hover:opacity-100 transition font-bold text-sm">Download &rarr;</span>
                </div>
            </div>
        </div>
    </div>

    <div id="uploader-modal" class="uploader-modal hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-8 relative">
            <button onclick="toggleUploader()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">‚úï</button>
            <h3 class="text-xl font-bold text-slate-900 mb-2">Upload Bank Specification</h3>
            <p class="text-sm text-slate-500 mb-6">Upload a CSV or Paste Rows to begin the assignment process.</p>
                <div id="drag-zone-modal" class="border-2 border-dashed border-slate-200 rounded-lg p-8 text-center hover:bg-slate-50 transition cursor-pointer drag-zone">
                <div class="text-4xl mb-2">üìÑ</div>
                <p class="text-sm font-medium text-slate-700">Drag & Drop CSV here</p>
            </div>
                <div class="mt-3 text-center">
                    <input id="csv-file-input" type="file" accept="text/csv,.csv" class="hidden">
                    <button id="btn-upload-csv" class="text-sm bg-blue-600 text-white px-3 py-2 rounded-md">Upload CSV</button>
                </div>
            <div class="mt-6">
                <h4 class="text-xs font-bold text-slate-500 uppercase mb-3">Unassigned Rows (Preview)</h4>
                <div id="unassigned-preview" class="border border-slate-200 rounded-lg h-48 overflow-y-auto bg-slate-50 p-2 space-y-2">
                    <p class="text-xs text-slate-500 p-3">No preview rows. Upload a CSV or paste rows to start.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="const-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4" role="dialog" aria-modal="true">
            <div class="p-4 border-b flex justify-between items-start">
                <div>
                    <h4 id="const-modal-title" class="font-bold text-slate-800">Constant</h4>
                    <p id="const-modal-sub" class="text-xs text-slate-500 mt-1">Value Type</p>
                </div>
                <div class="flex items-center gap-2">
                    <button id="const-copy-key" class="text-sm text-blue-600">Copy Key</button>
                    <button onclick="closeConstModal()" class="text-sm text-slate-500">Close</button>
                </div>
            </div>
            <div class="p-4">
                <div id="const-modal-desc" class="text-sm text-slate-700 leading-relaxed"></div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA & CONFIG ---
        const masterMappings = {};
        const STORAGE_KEY = 'solutioning-workbench-state-v1';
        let currentMode = 'enrichment'; // 'enrichment' or 'logical'

        const MODE_CONFIG = {
            enrichment: {
                label: 'Data Enrichment Story',
                targets: [
                    { id: 'erp-native-body', label: 'ERP', color: 'purple' },
                    { id: 'erp-plugin-body', label: 'PLG', color: 'blue' },
                    { id: 'platform-workbench-body', label: 'PLT', color: 'indigo' }
                ],
                nav: [
                    { href: '#phase-2', icon: 'üñ•Ô∏è', label: '2. ERP & Plugin' },
                    { href: '#phase-3', icon: '‚öôÔ∏è', label: '3. Platform Logic' }
                ],
                sections: [
                    {
                        id: 'phase-2', badge: 'PHASE 2', badgeColor: 'purple', title: 'ERP & Plugin Context', index: 2,
                        components: [
                            { id: 'erp-native-body', title: '2A. Native ERP Data', source: 'General Ledger', desc: 'Data pulled directly from the ERP (e.g., Vendor Master, Open Bills).', btnLabel: 'Add Native Mapping' },
                            { id: 'erp-plugin-body', title: '2B. Plugin Enrichment', source: 'User Input', desc: 'Data configured or input by the user at runtime.', btnLabel: 'Add Plugin Mapping' }
                        ],
                        qa: 'q-phase-2'
                    },
                    {
                        id: 'phase-3', badge: 'PHASE 3', badgeColor: 'indigo', title: 'FISPAN Platform Logic', index: 3,
                        components: [
                            { id: 'platform-workbench-body', title: 'Transformation Rules', desc: 'Transformation Rules & Validation Gates (e.g., File Naming, Encryption).', btnLabel: 'Add Logic Rule' }
                        ],
                        qa: 'q-phase-3'
                    }
                ],
                tags: [
                    { id: 'payer', label: 'Payer' }, { id: 'payee', label: 'Payee' }, { id: 'bill', label: 'Bill' }
                ]
            },
            logical: {
                label: 'Logical Isolation Story',
                targets: [
                    { id: 'phase-fc-body', label: 'FC', color: 'slate' },
                    { id: 'phase-ed-body', label: 'ED', color: 'blue' },
                    { id: 'phase-pi-body', label: 'PI', color: 'emerald' },
                    { id: 'phase-rm-body', label: 'RM', color: 'amber' }
                ],
                nav: [
                    { href: '#phase-fc', icon: 'üìÇ', label: 'File Control' },
                    { href: '#phase-ed', icon: 'üë•', label: 'Entity Details' },
                    { href: '#phase-pi', icon: 'üí∏', label: 'Payment Instruction' },
                    { href: '#phase-rm', icon: 'üßæ', label: 'Remittance Data' }
                ],
                sections: [
                    {
                        id: 'phase-fc', badge: 'THE ENVELOPE', badgeColor: 'slate', title: 'File Control', index: 2,
                        desc: 'Metadata that tells the bank how to process the file (Dates, Totals).',
                        components: [{ id: 'phase-fc-body', title: 'Control Headers/Trailers', btnLabel: 'Add Control Mapping' }], qa: 'q-phase-fc'
                    },
                    {
                        id: 'phase-ed', badge: 'THE ACTORS', badgeColor: 'blue', title: 'Entity Details', index: 3,
                        desc: 'Payer & Payee Info: The two parties involved in the transaction.',
                        components: [{ id: 'phase-ed-body', title: 'Payer & Payee Fields', btnLabel: 'Add Entity Mapping' }], qa: 'q-phase-ed'
                    },
                    {
                        id: 'phase-pi', badge: 'THE ACTION', badgeColor: 'emerald', title: 'Payment Instruction', index: 3, 
                        desc: 'The specific transfer of value (Check Num, Amount, Date).',
                        components: [{ id: 'phase-pi-body', title: 'Instruction Fields', btnLabel: 'Add Instruction Mapping' }], qa: 'q-phase-pi'
                    },
                    {
                        id: 'phase-rm', badge: 'THE CONTEXT', badgeColor: 'amber', title: 'Remittance Data', index: 3,
                        desc: 'Information the vendor needs to reconcile their books (Invoice #s).',
                        components: [{ id: 'phase-rm-body', title: 'Remittance Fields', btnLabel: 'Add Remittance Mapping' }], qa: 'q-phase-rm'
                    }
                ],
                tags: [
                    { id: 'fc', label: 'File Control' }, { id: 'ed', label: 'Entity Details' }, 
                    { id: 'pi', label: 'Payment Instr.' }, { id: 'rm', label: 'Remittance' }
                ]
            }
        };

        // --- MODE LOGIC ---
        function switchMode(mode) {
            if (!MODE_CONFIG[mode]) return;
            saveState(); 
            currentMode = mode;
            // UI Update
            document.querySelectorAll('.mode-toggle-btn').forEach(b => {
                b.classList.remove('bg-white','shadow-sm','text-slate-800');
                b.classList.add('text-slate-500');
            });
            const activeBtn = document.getElementById(`btn-mode-${mode}`);
            if(activeBtn) {
                activeBtn.classList.add('bg-white','shadow-sm','text-slate-800');
                activeBtn.classList.remove('text-slate-500');
            }
            localStorage.setItem(STORAGE_KEY + ':mode', mode);
            renderNav();
            renderWorkbench();
            loadState(); 
            renderGaps();
        }

        function renderNav() {
            const nav = document.getElementById('main-nav');
            const config = MODE_CONFIG[currentMode];
            if (!nav) return;
            let html = `
                <div class="px-6 mb-2 text-xs font-bold text-slate-500 uppercase tracking-wider">Solution Phases</div>
                <a href="#spec-manager" class="nav-item flex items-center px-6 py-3 hover:bg-slate-800 transition group text-blue-400">
                    <span class="mr-3 text-lg">üì§</span> <span class="font-medium text-sm">Spec Manager</span>
                </a>
                <a href="#phase-1" class="nav-item flex items-center px-6 py-3 hover:bg-slate-800 transition group">
                    <span class="mr-3 text-lg">üîå</span> <span class="font-medium text-sm">1. Connectivity</span>
                </a>
            `;
            config.nav.forEach(n => {
                html += `
                    <a href="${n.href}" class="nav-item flex items-center px-6 py-3 hover:bg-slate-800 transition group">
                        <span class="mr-3 text-lg">${n.icon}</span> <span class="font-medium text-sm">${n.label}</span>
                    </a>
                `;
            });
            html += `
                <a href="#phase-4" class="nav-item flex items-center px-6 py-3 hover:bg-slate-800 transition group">
                    <span class="mr-3 text-lg">üè¶</span> <span class="font-medium text-sm">4. Bank Spec</span>
                </a>
            `;
            nav.innerHTML = html;
        }

        function renderWorkbench() {
            const container = document.getElementById('dynamic-workbench-container');
            if (!container) return;
            container.innerHTML = ''; 
            const config = MODE_CONFIG[currentMode];
            
            config.sections.forEach(sec => {
                const section = document.createElement('section');
                section.id = sec.id;
                section.className = 'scroll-mt-24 pt-12 border-t border-dashed border-slate-200 mt-12 group';
                section.dataset.index = sec.index; 

                let compsHtml = '';
                sec.components.forEach(comp => {
                    compsHtml += `
                        <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm relative mb-8">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="font-bold text-slate-800">${comp.title}</h4>
                                ${comp.source ? `<span class="badge badge-purple">Source: ${comp.source}</span>` : ''}
                            </div>
                            ${comp.desc ? `<p class="text-slate-600 text-sm mb-4">${comp.desc}</p>` : ''}
                            <div class="border border-slate-200 rounded-lg overflow-hidden mb-4">
                                <table class="w-full text-sm text-left">
                                    <thead class="bg-slate-50 text-slate-700 font-bold">
                                        <tr><th class="p-3 border-b bg-slate-100 w-1/3">Spec Requirement</th><th class="p-3 border-b bg-slate-100 w-1/3">FISPAN Source</th><th class="p-3 border-b bg-slate-100">Status</th><th class="p-3 border-b bg-slate-100 text-right">Action</th></tr>
                                    </thead>
                                    <tbody id="${comp.id}" class="divide-y divide-slate-100"></tbody>
                                </table>
                                <div class="p-2 bg-slate-50 border-t border-slate-200 text-center"><button onclick="addRow('${comp.id}')" class="text-xs text-blue-600 font-bold hover:text-blue-800">+ ${comp.btnLabel}</button></div>
                            </div>
                        </div>
                    `;
                });

                section.innerHTML = `
                    <div class="flex items-center mb-6">
                        <span class="bg-${sec.badgeColor}-100 text-${sec.badgeColor}-700 font-bold px-3 py-1 rounded text-sm mr-3">${sec.badge}</span>
                        <h3 class="text-2xl font-bold text-slate-900">${sec.title}</h3>
                    </div>
                    ${sec.desc ? `<p class="mb-6 text-slate-600">${sec.desc}</p>` : ''}
                    ${compsHtml}
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <h5 class="text-xs font-bold text-slate-500 uppercase mb-3">Solutioning Questions</h5>
                        <div class="space-y-3" id="${sec.qa}"></div>
                        <div class="mt-3 relative inline-block text-left w-full">
                            <button onclick="addCustomQuestion('${sec.qa}')" class="flex items-center text-xs font-bold text-blue-600 hover:text-blue-800 transition bg-white border border-blue-200 px-3 py-2 rounded-lg shadow-sm justify-between"><span>+ Add Question</span></button>
                        </div>
                         <div class="mt-4 border-t border-slate-200 pt-2">
                             <button onclick="addNote('${sec.qa}')" class="text-xs text-slate-400 hover:text-slate-600 flex items-center"><span class="mr-1">+</span> Add Note</button>
                        </div>
                    </div>
                `;
                container.appendChild(section);
            });
        }

        // --- CORE LOGIC (Persistence, Editing) ---
        function loadState() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (!raw) return;
                const state = JSON.parse(raw);
                if(state.master) Object.assign(masterMappings, state.master);
                const modeKey = currentMode; 
                const modeData = state[modeKey] || {};
                const config = MODE_CONFIG[currentMode];
                config.sections.forEach(sec => {
                    sec.components.forEach(comp => {
                        const tbody = document.getElementById(comp.id);
                        if(tbody && modeData[comp.id]) {
                            tbody.innerHTML = '';
                            modeData[comp.id].forEach(r => createTableRow(tbody, r));
                        }
                    });
                    if(modeData[sec.qa]) {
                       const qContainer = document.getElementById(sec.qa);
                       if(qContainer) {
                           qContainer.innerHTML = '';
                           modeData[sec.qa].forEach(q => createQuestionEl(qContainer, q.text, q.answer, q.confirmed, q.note));
                       }
                    }
                });
                const staging = document.getElementById('unassigned-staging');
                if (staging && modeData.staging) {
                    staging.innerHTML = '';
                    modeData.staging.forEach(s => createStagingRow(staging, s.text, s.category));
                }
                renderFullSpec();
            } catch (e) { console.warn('loadState failed', e); }
        }

        function saveState() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                const state = raw ? JSON.parse(raw) : {};
                state.master = masterMappings;
                const modeKey = currentMode;
                const modeData = { staging: [] };
                const config = MODE_CONFIG[currentMode];
                config.sections.forEach(sec => {
                    sec.components.forEach(comp => {
                        const tbody = document.getElementById(comp.id);
                        if(tbody) {
                            modeData[comp.id] = [];
                            Array.from(tbody.querySelectorAll('tr')).forEach(tr => modeData[comp.id].push(extractRowData(tr)));
                        }
                    });
                    const qContainer = document.getElementById(sec.qa);
                    if(qContainer) {
                         modeData[sec.qa] = [];
                         Array.from(qContainer.querySelectorAll('.question-row')).forEach(row => {
                             modeData[sec.qa].push({
                                 text: row.querySelector('.q-text').innerText || row.querySelector('.q-text').value,
                                 answer: row.querySelector('textarea.answer-text') ? row.querySelector('textarea.answer-text').value : '',
                                 confirmed: row.classList.contains('confirmed'),
                                 note: row.parentElement.querySelector('.note-area textarea') ? row.parentElement.querySelector('.note-area textarea').value : ''
                             });
                         });
                    }
                });
                const staging = document.getElementById('unassigned-staging');
                if(staging) {
                    Array.from(staging.children).forEach(d => {
                        const span = d.querySelector('span');
                        if(span) modeData.staging.push({ text: span.title || span.innerText, category: d.dataset.category });
                    });
                }
                state[modeKey] = modeData;
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            } catch(e) { console.error(e); }
        }

        function extractRowData(tr) {
            const spec = tr.children[0].innerText.replace(tr.children[0].querySelector('.tag-badge')?.innerText || '', '').trim();
            const mapInput = tr.children[1].querySelector('input');
            const mapping = mapInput ? mapInput.value : tr.children[1].innerText;
            const statusBadge = tr.children[2].querySelector('.status-badge') || tr.children[2].querySelector('select');
            const status = statusBadge.value || statusBadge.innerText;
            const category = tr.dataset.category;
            return { spec, mapping, status, category };
        }

        function createTableRow(tbody, data) {
            const tr = document.createElement('tr');
            const catHtml = data.category ? `<span class="tag-badge">${data.category}</span>` : '';
            
            // Visual Split Logic
            let specDisplay = data.spec;
            const match = data.spec.match(/^Row\s+(\d+)[:\s]+(.*)/i);
            if (match) {
                specDisplay = `<span class="row-id-badge">Row ${match[1]}</span><span class="font-bold text-slate-700 text-sm">${match[2]}</span>`;
            } else {
                specDisplay = `<span class="text-sm font-medium text-slate-700">${data.spec}</span>`;
            }

            tr.innerHTML = `
                <td class="p-3 align-middle">${specDisplay} ${catHtml}</td>
                <td class="p-3">
                    <div class="autocomplete-wrapper">
                        <input type="text" placeholder="Map to..." value="${data.mapping||''}" class="w-full bg-transparent border-b border-slate-300 focus:border-blue-500 outline-none text-sm" onchange="saveState()" autocomplete="off">
                        <div class="autocomplete-list"></div>
                    </div>
                </td>
                <td class="p-3 align-middle"></td>
                <td class="p-3 text-right align-middle"><button class="text-xs text-blue-600 hover:underline" onclick="editRow(this)">Edit</button></td>
            `;
            if(data.category) tr.dataset.category = data.category;
            tbody.appendChild(tr);
            
            setupFispanAutocomplete(tr.querySelector('input'), tr.querySelector('.autocomplete-list'));

            const tdStatus = tr.children[2];
            const badge = document.createElement('span');
            badge.className = `status-badge ${data.status||'pending'}`;
            badge.innerText = data.status||'pending';
            tdStatus.appendChild(badge);
        }

        function setupFispanAutocomplete(input, list) {
            input.addEventListener('input', (e) => {
                const val = e.target.value.toLowerCase();
                if (!val) { list.style.display = 'none'; return; }
                const matches = Object.values(masterMappings).filter(m => 
                    m.key.toLowerCase().includes(val) || (m.description && m.description.toLowerCase().includes(val))
                );
                list.innerHTML = '';
                if(matches.length > 0) {
                    list.style.display = 'block';
                    matches.slice(0, 10).forEach(m => { 
                        const div = document.createElement('div');
                        div.className = 'autocomplete-item';
                        div.innerHTML = `<strong>${m.key}</strong><span class="autocomplete-desc">${m.description || ''}</span>`;
                        div.onclick = () => {
                            input.value = m.key;
                            list.style.display = 'none';
                            saveState();
                            renderGaps(); 
                        };
                        list.appendChild(div);
                    });
                } else {
                    list.style.display = 'none';
                }
            });
            input.addEventListener('blur', () => setTimeout(() => list.style.display = 'none', 200));
            input.addEventListener('focus', (e) => { if(e.target.value) e.target.dispatchEvent(new Event('input')); });
        }

        function createStagingRow(container, text, category) {
            const div = document.createElement('div');
            div.className = 'flex items-center justify-between p-2 bg-slate-50 rounded border border-slate-100 hover:border-blue-300 group/row';
            if(category) div.dataset.category = category;
            
            const left = document.createElement('div');
            left.className = "flex items-center gap-2 overflow-hidden";
            const tagBtn = document.createElement('button');
            tagBtn.className = 'text-[10px] text-slate-400 hover:text-blue-600';
            tagBtn.innerHTML = 'üè∑';
            tagBtn.onclick = (e) => {
                e.stopPropagation();
                const cats = MODE_CONFIG[currentMode].tags.map(t => t.id);
                let idx = cats.indexOf(div.dataset.category || '');
                idx = (idx + 1) % (cats.length + 1); 
                const newCat = idx === cats.length ? '' : cats[idx];
                if(newCat) div.dataset.category = newCat; else delete div.dataset.category;
                refreshStagingRowUI(div, text, newCat);
                saveState();
            };
            left.appendChild(tagBtn);
            const s = document.createElement('span');
            s.className = 'text-xs font-mono text-slate-700 truncate max-w-[150px]';
            s.title = text; s.innerText = text;
            left.appendChild(s);
            if(category) { const b = document.createElement('span'); b.className = 'tag-badge'; b.innerText = category; left.appendChild(b); }
            div.appendChild(left);
            const btnDiv = document.createElement('div');
            btnDiv.className = 'flex gap-1 opacity-50 group-hover/row:opacity-100 transition';
            MODE_CONFIG[currentMode].targets.forEach(t => {
                const btn = document.createElement('button');
                btn.className = `text-[10px] bg-${t.color}-100 text-${t.color}-700 px-2 py-1 rounded hover:bg-${t.color}-200`;
                btn.innerText = t.label;
                btn.onclick = () => assignRow(btn, t.id);
                btnDiv.appendChild(btn);
            });
            div.appendChild(btnDiv);
            container.appendChild(div);
        }
        function refreshStagingRowUI(div, text, category) { div.innerHTML = ''; createStagingRow(div.parentElement, text, category); div.remove(); }

        function assignRow(btn, targetId) {
            let rowEl = btn.closest('.group\\/row');
            if (!rowEl) return;
            const span = rowEl.querySelector('span[title]');
            const text = span ? span.innerText : '';
            const category = rowEl.dataset.category;
            const tbody = document.getElementById(targetId);
            if(tbody) {
                createTableRow(tbody, { spec: text, mapping: '', status: 'pending', category });
                rowEl.remove();
                saveState();
                renderGaps();
                showToast('Assigned to ' + targetId, 'success');
            }
        }
        function addRow(tbodyId) {
            createTableRow(document.getElementById(tbodyId), { spec: 'New Requirement', mapping: '', status: 'pending' });
            saveState();
        }
        function editRow(btn) {
            const tr = btn.closest('tr');
            const actionTd = tr.children[3];
            actionTd.innerHTML = `
                <div class="flex gap-2 justify-end">
                     <button class="text-xs text-blue-600" onclick="saveRowBtn(this)">Save</button>
                     <button class="text-xs text-red-600" onclick="toggleUnassignMark(this)">Unassign</button>
                </div>
            `;
        }
        function saveRowBtn(btn) {
            const tr = btn.closest('tr');
            if(tr.dataset.unassign === '1') {
                const spec = tr.children[0].innerText.replace(tr.dataset.category || '', '').trim();
                const cat = tr.dataset.category;
                createStagingRow(document.getElementById('unassigned-staging'), spec, cat);
                tr.remove();
            } else {
                const actionTd = tr.children[3];
                actionTd.innerHTML = `<button class="text-xs text-blue-600 hover:underline" onclick="editRow(this)">Edit</button>`;
            }
            saveState();
            renderGaps();
        }
        function toggleUnassignMark(btn) {
            const tr = btn.closest('tr');
            if(tr.dataset.unassign === '1') {
                delete tr.dataset.unassign; tr.classList.remove('unassign-mark'); btn.innerText = 'Unassign';
            } else {
                tr.dataset.unassign = '1'; tr.classList.add('unassign-mark'); btn.innerText = 'Undo';
            }
        }

        // --- Deep Linking for Gaps (Scroll To Row) ---
        function scrollToRow(specText) {
            const cells = document.querySelectorAll('td:first-child');
            for(let td of cells) {
                if(td.innerText.includes(specText)) {
                    const tr = td.parentElement;
                    tr.scrollIntoView({behavior: 'smooth', block: 'center'});
                    tr.classList.add('highlight-flash');
                    setTimeout(()=>tr.classList.remove('highlight-flash'), 2000);
                    const input = tr.querySelector('input');
                    if(input) input.focus();
                    return;
                }
            }
            showToast('Row not found in current view', 'error');
        }

        // --- Question Builder Logic (Restored) ---
        function addCustomQuestion(containerId) {
             const c = document.getElementById(containerId);
             const div = document.createElement('div');
             div.className = 'question-row flex flex-col p-3 bg-white rounded border border-blue-200 shadow-sm mt-2 animate-pulse';
             div.innerHTML = `
                <div class="flex items-start w-full">
                    <div class="flex-shrink-0 pt-0.5 cursor-pointer mr-3 text-slate-300 hover:text-emerald-500 transition" onclick="toggleConfirm(this.closest('.question-row'))"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
                    <input type="text" placeholder="Type your custom question..." class="q-text w-full text-sm outline-none bg-transparent font-medium text-slate-700" onblur="this.parentElement.parentElement.classList.remove('animate-pulse')">
                </div>
                <div class="mt-2 w-full pl-8"><button onclick="toggleAnswer(this)" class="text-[10px] font-bold text-blue-500 hover:text-blue-700 mb-1">+ Add Answer</button><div class="answer-box hidden"><textarea class="answer-text w-full text-xs bg-slate-50 border border-slate-200 rounded p-2 outline-none focus:border-blue-300" rows="2" placeholder="Answer..."></textarea></div></div>
             `;
             c.appendChild(div);
             div.querySelector('input').focus();
        }
        function createQuestionEl(container, text, ans, confirmed, note) {
             const div = document.createElement('div');
             div.className = `question-row flex flex-col p-3 bg-white rounded border border-slate-200 mt-2 ${confirmed?'confirmed':''}`;
             div.innerHTML = `
                <div class="flex items-start w-full">
                    <div class="flex-shrink-0 pt-0.5 cursor-pointer mr-3 ${confirmed?'text-emerald-600':'text-slate-300'} hover:text-emerald-500 transition" onclick="toggleConfirm(this.closest('.question-row'))"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
                    <p class="q-text text-sm font-medium ${confirmed?'text-emerald-700 line-through':''}">${text}</p>
                </div>
                <div class="mt-2 w-full pl-8">
                    <button onclick="toggleAnswer(this)" class="text-[10px] font-bold text-blue-500 hover:text-blue-700 mb-1">${ans ? '- Hide Answer' : '+ Add Answer'}</button>
                    <div class="answer-box ${ans ? 'visible' : 'hidden'}"><textarea class="answer-text w-full text-xs bg-slate-50 border border-slate-200 rounded p-2 outline-none focus:border-blue-300" rows="2" placeholder="Answer...">${ans||''}</textarea></div>
                </div>
             `;
             container.appendChild(div);
             if(note) addNote(container.id, note);
        }
        function toggleConfirm(row) {
            row.classList.toggle('confirmed');
            const icon = row.querySelector('svg').parentElement;
            const text = row.querySelector('.q-text');
            if(row.classList.contains('confirmed')) { icon.classList.remove('text-slate-300'); icon.classList.add('text-emerald-600'); text.classList.add('text-emerald-700','line-through'); }
            else { icon.classList.add('text-slate-300'); icon.classList.remove('text-emerald-600'); text.classList.remove('text-emerald-700','line-through'); }
            saveState();
        }
        function toggleAnswer(btn) {
            const box = btn.nextElementSibling;
            box.classList.toggle('hidden'); box.classList.toggle('visible');
            btn.innerText = box.classList.contains('hidden') ? "+ Add Answer" : "- Hide Answer";
        }
        function addNote(containerId, initialValue='') {
             const c = document.getElementById(containerId).parentElement;
             let note = c.querySelector('.note-area');
             if(!note) {
                 note = document.createElement('div'); note.className = "mt-4 border-t border-slate-100 pt-3 note-area";
                 note.innerHTML = `<h6 class="text-[10px] font-bold text-slate-400 uppercase mb-2">Notes</h6><textarea class="w-full text-sm bg-yellow-50 border border-yellow-100 rounded p-2 text-slate-700 focus:outline-none focus:border-yellow-300 shadow-sm" rows="3" placeholder="Add context...">${initialValue}</textarea>`;
                 c.appendChild(note);
             }
             if(!initialValue) note.querySelector('textarea').focus();
        }

        // --- Master Spec Features (Restored) ---
        function renderFullSpec() {
            const tbody = document.getElementById('full-spec-body');
            tbody.innerHTML = '';
            const filter = (window.__masterFilter || '').toLowerCase().trim();
            const rows = Object.values(masterMappings).sort((a,b)=>(a.key.localeCompare(b.key)));
            let visibleCount = 0;
            rows.forEach(m => {
                 if (filter && !(m.key+m.valueType+(m.spec||'')).toLowerCase().includes(filter)) return;
                 visibleCount++;
                 const tr = document.createElement('tr');
                 tr.className = 'hover:bg-slate-50 border-b border-slate-100';
                 const specDisplay = m.spec ? `<span class="text-blue-700 font-medium">${m.spec}</span> <button class="ml-2 text-[10px] text-red-400 hover:text-red-600 master-clear" data-const="${m.key}">‚úï</button>` : `<button class="text-[10px] px-2 py-1 bg-slate-100 rounded master-attach" data-const="${m.key}">Attach</button>`;
                 tr.innerHTML = `<td class="p-3 font-mono text-xs text-blue-600"><span class="spec-key" title="${m.key}">${m.key}</span><button class="ml-2 text-slate-300 hover:text-blue-500 master-copy" data-const="${m.key}">üìã</button></td><td class="p-3 text-xs text-slate-500">${m.valueType}</td><td class="p-3 text-sm">${specDisplay}</td><td class="p-3"><span class="status-badge ${m.status}" data-const="${m.key}">${m.status}</span></td>`;
                 tbody.appendChild(tr);
            });
            document.getElementById('master-count').innerText = visibleCount;
        }
        function getAllSpecPool() {
            const set = new Set();
            const staging = document.getElementById('unassigned-staging');
            if(staging) Array.from(staging.querySelectorAll('span')).forEach(s => set.add(s.innerText.trim()));
            const targets = MODE_CONFIG[currentMode].targets.map(t=>t.id);
            targets.forEach(id => {
                const tb = document.getElementById(id);
                if(tb) Array.from(tb.querySelectorAll('tr')).forEach(tr=>set.add(tr.children[0].innerText.replace(tr.dataset.category||'','').trim()));
            });
            return Array.from(set).filter(s=>s.length);
        }
        function assignSpecToConstant(constKey, spec) {
             masterMappings[constKey].spec = spec;
             masterMappings[constKey].status = 'mapped';
             renderFullSpec(); saveState();
        }
        document.addEventListener('click', e => {
             const attachBtn = e.target.closest('.master-attach');
             if(attachBtn) {
                 const key = attachBtn.dataset.const;
                 const pool = getAllSpecPool();
                 const widget = document.createElement('div'); widget.className = 'attach-widget';
                 widget.innerHTML = `<input class="attach-input" placeholder="Search spec..."><div class="attach-list hidden"></div>`;
                 attachBtn.replaceWith(widget);
                 const input = widget.querySelector('input'); const list = widget.querySelector('.attach-list');
                 const filterList = (v) => {
                     list.innerHTML = ''; 
                     pool.filter(p=>p.toLowerCase().includes(v.toLowerCase())).forEach(p=>{
                         const it = document.createElement('div'); it.className='attach-item'; it.innerText=p;
                         it.onclick=()=>{assignSpecToConstant(key, p)}; list.appendChild(it);
                     });
                     if(!list.children.length) list.innerHTML='<div class="p-2 text-xs text-gray-400">No matches</div>';
                 };
                 input.addEventListener('input', (ev)=>{ list.classList.remove('hidden'); filterList(ev.target.value); });
                 input.addEventListener('focus', ()=>{ list.classList.remove('hidden'); filterList(''); });
                 input.addEventListener('blur', ()=>{ setTimeout(()=>{ if(widget.parentNode) { widget.replaceWith(attachBtn); } }, 200); });
                 input.focus();
             }
             const clearBtn = e.target.closest('.master-clear');
             if(clearBtn) { masterMappings[clearBtn.dataset.const].spec = ''; masterMappings[clearBtn.dataset.const].status='pending'; renderFullSpec(); saveState(); }
             const copyBtn = e.target.closest('.master-copy');
             if(copyBtn) { navigator.clipboard.writeText(copyBtn.dataset.const); showToast('Copied'); }
             // Master status edit
             const ms = e.target.closest('.status-badge[data-const]');
             if(ms) {
                  const sel = document.createElement('select'); sel.className='text-xs border rounded';
                  ['pending','mapped','gap'].forEach(v=>sel.add(new Option(v,v,false,v===ms.innerText)));
                  sel.onchange=()=>{ masterMappings[ms.dataset.const].status=sel.value; renderFullSpec(); saveState(); };
                  sel.onblur=()=>renderFullSpec();
                  ms.replaceWith(sel); sel.focus();
             }
        });
        document.getElementById('master-search').addEventListener('input', (e)=>{ window.__masterFilter=e.target.value; renderFullSpec(); });
        document.getElementById('master-toggle-wrap').onclick = function() { document.querySelectorAll('.spec-key').forEach(s=>s.classList.toggle('wrap')); this.querySelector('span').innerText = this.querySelector('span').innerText==='off'?'on':'off'; };

        // --- Export Logic ---
        function toggleExport() { document.getElementById('export-modal').classList.toggle('hidden'); }
        
        function getExportData() {
            const data = { title: MODE_CONFIG[currentMode].label, sections: [] };
            MODE_CONFIG[currentMode].sections.forEach(sec => {
                const sectionData = { title: sec.title, rows: [], questions: [] };
                sec.components.forEach(comp => {
                    const tbody = document.getElementById(comp.id);
                    if(tbody) Array.from(tbody.querySelectorAll('tr')).forEach(tr => {
                        const rd = extractRowData(tr);
                        sectionData.rows.push(rd);
                    });
                });
                const qContainer = document.getElementById(sec.qa);
                if(qContainer) Array.from(qContainer.querySelectorAll('.question-row')).forEach(row => {
                    sectionData.questions.push({
                        q: row.querySelector('.q-text').innerText || row.querySelector('.q-text').value,
                        a: row.querySelector('textarea.answer-text')?.value || ''
                    });
                });
                data.sections.push(sectionData);
            });
            return data;
        }

        async function copyToClipboardHTML() {
            const data = getExportData();
            let html = `<h1>${data.title}</h1>`;
            data.sections.forEach(sec => {
                html += `<h2>${sec.title}</h2><table border="1" style="border-collapse:collapse;width:100%"><tr><th>Spec Requirement</th><th>FISPAN Source</th><th>Status</th></tr>`;
                sec.rows.forEach(r => html += `<tr><td>${r.spec}</td><td>${r.mapping}</td><td>${r.status}</td></tr>`);
                html += `</table>`;
                if(sec.questions.length) {
                    html += `<h3>Questions</h3><ul>` + sec.questions.map(q => `<li><strong>Q:</strong> ${q.q}<br><strong>A:</strong> ${q.a}</li>`).join('') + `</ul>`;
                }
                html += `<br>`;
            });
            
            try {
                const blob = new Blob([html], { type: 'text/html' });
                const item = new ClipboardItem({ 'text/html': blob });
                await navigator.clipboard.write([item]);
                showToast('Copied to Clipboard!', 'success');
                toggleExport();
            } catch(e) { console.error(e); showToast('Copy failed', 'error'); }
        }

        function downloadCSV() {
            const data = getExportData();
            let csv = 'Section,Spec Requirement,FISPAN Source,Status\n';
            data.sections.forEach(sec => {
                sec.rows.forEach(r => {
                    csv += `"${sec.title}","${r.spec.replace(/"/g,'""')}","${r.mapping.replace(/"/g,'""')}","${r.status}"\n`;
                });
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `solutioning-export-${currentMode}.csv`;
            a.click();
            toggleExport();
        }

        // --- Boilerplate (CSV, Toast, etc) ---
        function toggleUploader(){ const m = document.getElementById('uploader-modal'); if(!m.classList.contains('hidden')) movePreviewToStaging(); m.classList.toggle('hidden'); }
        async function loadFispanConstants() {
            try {
                const paths = ['docs/data/fispan-constants.flat.json', 'data/fispan-constants.flat.json', './data/fispan-constants.flat.json'];
                let res; for(let p of paths) { try { res = await fetch(p); if(res.ok) break; } catch(e){} }
                const constants = await res.json();
                constants.forEach(c => { if (!masterMappings[c.key]) masterMappings[c.key] = { key: c.key, valueType: c.valueType||'', description: c.description||'', spec: '', status: 'pending' }; });
                renderFullSpec();
            } catch (e) { console.warn('Fetch error', e); renderFullSpec(); }
        }
        function switchTab(t) {
            ['summary','full','visualizer','tags'].forEach(x => { document.getElementById('view-'+x).classList.add('hidden'); document.getElementById('btn-'+x).classList.remove('active'); });
            document.getElementById('view-'+t).classList.remove('hidden'); document.getElementById('btn-'+t).classList.add('active');
            if(t==='tags') renderTagsView();
        }
        function renderTagsView() {
            const el = document.getElementById('view-tags'); if (!el) return;
            const config = MODE_CONFIG[currentMode];
            const groups = { untagged: [] }; config.tags.forEach(t => groups[t.id] = []);
            config.sections.forEach(sec => { sec.components.forEach(comp => { const tbody = document.getElementById(comp.id); if(tbody) Array.from(tbody.querySelectorAll('tr')).forEach(tr => { const spec = tr.children[0].innerText.replace(tr.dataset.category||'','').trim(); const cat = tr.dataset.category; if(cat && groups[cat]) groups[cat].push(spec); else groups.untagged.push(spec); }); }); });
            let html = '';
            Object.keys(groups).forEach(k => { if(groups[k].length) html += `<div class="mb-4 p-3 bg-white rounded border"><div class="font-bold text-sm mb-2">${k==='untagged'?'Untagged':(config.tags.find(t=>t.id===k)?.label||k)} (${groups[k].length})</div><ul class="text-sm list-disc pl-5">${groups[k].map(s=>`<li>${s}</li>`).join('')}</ul></div>`; });
            el.innerHTML = html || '<p class="text-slate-500 text-xs">No data found.</p>';
        }
        function showToast(msg, type='info') { const c = document.getElementById('toast-container') || document.body.appendChild(Object.assign(document.createElement('div'),{id:'toast-container'})); const t = document.createElement('div'); t.className = `toast ${type}`; t.innerText = msg; c.appendChild(t); setTimeout(()=>t.classList.add('show'),10); setTimeout(()=>t.remove(), 3000); }
        function saveNow() { saveState(); showToast('Saved', 'success'); }
        function resetState() { if(confirm('Reset?')) { localStorage.removeItem(STORAGE_KEY); location.reload(); } }
        
        // --- CSV Handler ---
        document.getElementById('btn-upload-csv').addEventListener('click', () => document.getElementById('csv-file-input').click());
        document.getElementById('csv-file-input').addEventListener('change', (e) => handleCSV(e.target.files[0]));
        function handleCSV(f) {
            const r = new FileReader(); r.onload = (e) => {
                const text = e.target.result;
                const rows = [];
                const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
                lines.forEach((line, idx) => {
                    // Manual parser to handle quotes
                    const cells = [];
                    let cur = '';
                    let inQuotes = false;
                    for (let i = 0; i < line.length; i++) {
                        const ch = line[i];
                        if (ch === '"') {
                            if (inQuotes && line[i+1] === '"') { cur += '"'; i++; }
                            else inQuotes = !inQuotes;
                        } else if (ch === ',' && !inQuotes) {
                            cells.push(cur); cur = '';
                        } else {
                            cur += ch;
                        }
                    }
                    cells.push(cur);
                    
                    // Logic: Use Col 1 (cells[0]) as the Row Text
                    const firstVal = (cells[0] || '').trim().replace(/^"|"$/g, '');
                    const rowText = firstVal; 
                    
                    if(rowText) rows.push({ row: idx + 1, first: rowText });
                });
                renderPreview(rows);
            };
            r.readAsText(f);
        }
        function renderPreview(rows) {
             const preview = document.getElementById('unassigned-preview'); preview.innerHTML = '';
             rows.forEach(r => {
                 const div = document.createElement('div'); div.className = 'flex items-center justify-between p-2 bg-white rounded shadow-sm row-item border border-slate-100 hover:border-blue-300';
                 div.innerHTML = `<span class="text-sm font-mono text-slate-700">Row ${r.row}: ${r.first}</span>`;
                 const btnDiv = document.createElement('div'); btnDiv.className = 'flex gap-1';
                 MODE_CONFIG[currentMode].targets.forEach(t => { const btn = document.createElement('button'); btn.className = `text-[10px] bg-${t.color}-100 text-${t.color}-700 px-2 py-1 rounded`; btn.innerText = t.label; btn.onclick = () => { const tbody = document.getElementById(t.id); if(tbody) { createTableRow(tbody, { spec: `Row ${r.row}: ${r.first}`, mapping: '', status: 'pending' }); div.remove(); saveState(); renderGaps(); } }; btnDiv.appendChild(btn); });
                 div.appendChild(btnDiv); preview.appendChild(div);
             });
        }
        function movePreviewToStaging() {
            const preview = document.getElementById('unassigned-preview'); const staging = document.getElementById('unassigned-staging');
            Array.from(preview.children).forEach(child => { const text = child.querySelector('span').innerText; createStagingRow(staging, text, ''); child.remove(); });
            saveState();
        }

        // --- Context & Feed Sync ---
        function updateContext(mode) {
             const ctx = document.getElementById('dynamic-context'); if(!ctx) return;
             if(mode === 'sftp') { ctx.className = 'mb-6 p-3 bg-blue-50 border border-blue-200 rounded text-sm text-blue-800 flex items-start'; ctx.innerHTML = '<span class="mr-2">üí°</span><p><strong>Nudge:</strong> Since SFTP is selected, suggest PGP Encryption for security compliance.</p>'; }
             else { ctx.className = 'mb-6 p-3 bg-amber-50 border border-amber-200 rounded text-sm text-amber-900 flex items-start'; ctx.innerHTML = '<span class="mr-2">‚ö†Ô∏è</span><p><strong>Caution:</strong> API implementations often require complex Idempotency logic.</p>'; }
        }
        function addPresetQuestion(id, text) { const c = document.getElementById(id); if(c) createQuestionEl(c, text); toggleDropdown(id.replace('q-','dd-')); }
        function toggleDropdown(id) { document.getElementById(id).classList.toggle('hidden'); }
        function closeConstModal() { document.getElementById('const-modal').classList.add('hidden'); document.getElementById('const-modal').classList.remove('flex'); }

        const contextToggle = document.getElementById('toggle-feed-context');
        const feedContainer = document.getElementById('feed-container');
        contextToggle.addEventListener('change', (e) => {
            if (e.target.checked) { feedContainer.classList.add('show-modals'); document.querySelectorAll('.feed-modal').forEach(m => m.classList.add('enabled')); }
            else { feedContainer.classList.remove('show-modals'); document.querySelectorAll('.feed-modal').forEach(m => m.classList.remove('enabled')); }
        });
        
        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            loadFispanConstants(); 
            const savedMode = localStorage.getItem(STORAGE_KEY + ':mode');
            if(savedMode && MODE_CONFIG[savedMode]) currentMode = savedMode;
            switchMode(currentMode);
            // Scroll Spy
            const mainScroll = document.getElementById('main-scroll');
            mainScroll.addEventListener('scroll', () => {
                 const sections = document.querySelectorAll('section');
                 let currentId = '';
                 sections.forEach(s => { if(mainScroll.scrollTop >= s.offsetTop - 300) currentId = s.id; });
                 document.querySelectorAll('.nav-item').forEach(n => { n.classList.remove('active'); if(n.getAttribute('href').includes(currentId)) n.classList.add('active'); });
                 let phaseIndex = 0;
                 if (currentId === 'phase-1') phaseIndex = 1; else if (currentId === 'phase-4') phaseIndex = 4;
                 else { const sec = document.getElementById(currentId); if(sec && sec.dataset.index) phaseIndex = parseInt(sec.dataset.index); }
                 document.querySelectorAll('.feed-item').forEach(item => { if(parseInt(item.dataset.phase) === phaseIndex) item.classList.add('active'); else item.classList.remove('active'); });
            });
        });
        
        // Status Update Delegate
        document.addEventListener('click', e => {
            if(e.target.matches('.status-badge') && !e.target.hasAttribute('data-const')) {
                const b = e.target; const vals = ['pending','mapped','gap'];
                const next = vals[(vals.indexOf(b.innerText)+1)%3];
                b.className = `status-badge ${next}`; b.innerText = next; saveState();
            }
        });
        function renderGaps() {
             const gaps = [];
             MODE_CONFIG[currentMode].sections.forEach(sec => sec.components.forEach(comp => { const tbody = document.getElementById(comp.id); if(tbody) Array.from(tbody.querySelectorAll('tr')).forEach(tr => { const mapInput = tr.children[1].querySelector('input'); const val = mapInput ? mapInput.value : tr.children[1].innerText; if(!val) gaps.push({ target: comp.title, spec: tr.children[0].innerText }); }); }));
             const c = document.getElementById('gaps-list');
             if(!gaps.length) { c.innerHTML = '<p class="text-xs text-slate-500">No gaps detected.</p>'; return; }
             const grp = {}; gaps.forEach(g => { grp[g.target] = grp[g.target] || []; grp[g.target].push(g.spec); });
             // Updated render logic for Quick Wins: Deep Linking and Icons
             let html = '<div class="space-y-3">'; 
             const icons = {'Control Headers/Trailers':'üìÇ','Payer & Payee Fields':'üë§','Instruction Fields':'üí∏','Remittance Fields':'üßæ','Native ERP Data':'üñ•Ô∏è','Plugin Enrichment':'üîå','Transformation Rules':'‚öôÔ∏è'};
             Object.keys(grp).forEach(k => {
                 const icon = icons[k] || 'üîπ';
                 html += `<div class="p-3 bg-white rounded border border-slate-200">
                    <div class="font-bold text-sm mb-2 text-slate-700">${icon} ${k}</div>
                    <ul class="space-y-1">
                        ${grp[k].map(s => {
                            // Strip "Row X:" part for cleaner gap text if possible, or just keep it
                            return `<li><button onclick="scrollToRow('${s.replace(/'/g,"\\'")}')" class="text-xs text-blue-600 hover:underline hover:text-blue-800 text-left w-full truncate block transition-colors">‚óè ${s}</button></li>`
                        }).join('')}
                    </ul>
                 </div>`; 
             }); 
             c.innerHTML = html + '</div>';
        }
    </script>
</body>
</html>