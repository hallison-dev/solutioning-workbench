<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solutioning Workbench: Solutioning Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body class="bg-stone-50 text-slate-800 h-screen flex overflow-hidden">

    <aside class="w-64 bg-slate-900 flex-shrink-0 flex flex-col h-full shadow-xl z-20 hidden md:flex">
        <div class="p-6 border-b border-slate-800">
            <h1 class="text-white font-bold text-lg tracking-tight">Solutioning Workbench <span class="text-blue-500 text-xs uppercase align-top">Beta</span></h1>
            <p class="text-slate-400 text-xs mt-1">Solutioning Builder v4.3</p>
        </div>
        
        <nav class="flex-1 overflow-y-auto py-6 space-y-1" id="main-nav">
            </nav>

        <div class="p-4 border-t border-slate-800">
            <div class="bg-slate-800 rounded p-3 flex items-center">
                <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white font-bold text-xs">SE</div>
                <div class="ml-3">
                    <p class="text-white text-sm font-medium">Hakeem A.</p>
                    <p class="text-slate-400 text-xs">Solutions Engineer</p>
                </div>
            </div>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto relative scroll-smooth p-8 md:p-12 space-y-24" id="main-scroll">
        
        <div class="w-full">
            <div class="flex justify-between items-end mb-12 border-b border-slate-200 pb-6">
                <div>
                    <h2 class="text-3xl font-extrabold text-slate-900">Check Print Solutioning</h2>
                    <p class="text-slate-500 mt-2">Target: <strong class="text-slate-800">Customers Bank</strong> | Spec: <span class="badge badge-blue">Flat File (CSV)</span></p>
                </div>
                <div class="flex flex-col items-end gap-3">
                    <div class="flex items-center bg-slate-100 rounded-lg p-1 border border-slate-200">
                        <button onclick="switchMode('enrichment')" id="btn-mode-enrichment" class="mode-toggle-btn px-3 py-1.5 rounded-md text-xs font-bold text-slate-500">Data Enrichment</button>
                        <button onclick="switchMode('logical')" id="btn-mode-logical" class="mode-toggle-btn px-3 py-1.5 rounded-md text-xs font-bold text-slate-500">Logical Story</button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="toggleUploader()" class="bg-white border border-slate-300 text-blue-600 px-3 py-2 rounded-lg text-xs font-semibold shadow-sm hover:bg-blue-50 flex items-center">
                            <span class="mr-2">üìÇ</span> Open Modal
                        </button>
                        <button onclick="toggleExport()" class="bg-blue-600 text-white px-3 py-2 rounded-lg text-xs font-semibold shadow-sm hover:bg-blue-700 flex items-center">
                            <span class="mr-2">üì§</span> Export Doc
                        </button>
                        <button onclick="saveNow()" class="bg-emerald-600 text-white px-3 py-2 rounded-lg text-xs font-semibold shadow-sm hover:bg-emerald-700">Save</button>
                        <button onclick="resetState()" class="bg-red-100 text-red-700 px-3 py-2 rounded-lg text-xs font-semibold shadow-sm hover:bg-red-200">Reset</button>
                    </div>
                </div>
            </div>

            <section id="spec-manager" class="scroll-mt-24 group">
                <div class="bg-white p-6 rounded-xl border border-blue-100 shadow-sm relative ring-1 ring-blue-50">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-slate-900 flex items-center">
                            <span class="bg-blue-100 text-blue-600 p-1 rounded mr-2 text-sm">üì§</span> 
                            Specification Manager
                        </h3>
                        <span class="text-xs text-slate-400">Assign raw spec rows to solution phases</span>
                    </div>
                    
                    <div class="flex flex-col gap-6">
                        <div class="w-full border-2 border-dashed border-slate-300 rounded-lg p-6 text-center hover:bg-slate-50 transition cursor-pointer bg-slate-50/50 drag-zone" id="drag-zone">
                            <div class="text-3xl mb-2">üìÑ</div>
                            <p class="text-sm font-medium text-slate-700">Standard Check Layout.csv</p>
                            <p class="text-xs text-emerald-600 font-bold mt-1">‚úì Ready</p>
                        </div>

                        <div class="w-full">
                            <h4 class="text-xs font-bold text-slate-500 uppercase mb-2">Unassigned Rows (Staging)</h4>
                            <div id="unassigned-staging" class="w-full">
                                <p class="text-xs text-slate-500 p-3 border rounded bg-white">No unassigned rows.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="phase-1" class="scroll-mt-24 group" data-index="0">
                <div class="flex items-center mb-6">
                    <span class="bg-blue-100 text-blue-700 font-bold px-3 py-1 rounded text-sm mr-3">PHASE 1</span>
                    <h3 class="text-2xl font-bold text-slate-900">Connectivity & Security</h3>
                </div>
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm relative">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="p-4 border rounded-lg hover:border-blue-300 transition relative group/card">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-bold text-slate-800">üì° Transport Protocol</h4>
                                <span class="text-slate-400 cursor-help hint-trigger">‚ÑπÔ∏è</span>
                                <div class="hint-box absolute right-4 top-10 w-64 bg-slate-800 text-white text-xs p-3 rounded shadow-xl z-20">
                                    <strong>Solution Mapping Context:</strong><br> SFTP: Faster implementation.<br> API: Real-time but complex.
                                </div>
                            </div>
                            <div class="space-y-2">
                                <label class="flex items-center space-x-2 p-2 rounded hover:bg-slate-50 cursor-pointer"><input type="radio" name="transport" class="text-blue-600" checked onchange="updateContext('sftp')"><span class="text-sm font-medium">SFTP (File Based)</span></label>
                                <label class="flex items-center space-x-2 p-2 rounded hover:bg-slate-50 cursor-pointer"><input type="radio" name="transport" class="text-blue-600" onchange="updateContext('api')"><span class="text-sm font-medium">API (Real-Time)</span></label>
                            </div>
                        </div>
                        <div class="p-4 border rounded-lg hover:border-blue-300 transition">
                            <h4 class="font-bold text-slate-800 mb-2">üîë Credential Scope</h4>
                            <div class="space-y-2">
                                <label class="flex items-center space-x-2"><input type="radio" name="scope" class="text-blue-600"><span class="text-sm">Gateway Level</span></label>
                                <label class="flex items-center space-x-2"><input type="radio" name="scope" class="text-blue-600" checked><span class="text-sm">Client Level</span></label>
                            </div>
                        </div>
                    </div>
                    <div id="dynamic-context" class="mb-6 p-3 bg-blue-50 border border-blue-200 rounded text-sm text-blue-800 flex items-start">
                        <span class="mr-2">üí°</span><p><strong>Nudge:</strong> Since SFTP is selected, suggest PGP Encryption for security compliance.</p>
                    </div>
                    <div class="pt-6 border-t border-slate-100 bg-slate-50/50 -mx-6 -mb-6 px-6 pb-6 rounded-b-xl">
                        <div class="space-y-3" id="q-phase-1"></div>
                        <div class="mt-3 relative inline-block text-left w-full">
                            <button onclick="toggleDropdown('dd-phase-1')" class="flex items-center text-xs font-bold text-blue-600 hover:text-blue-800 transition bg-white border border-blue-200 px-3 py-2 rounded-lg shadow-sm w-full justify-between"><span>+ Add Scoping Question</span><span>‚ñº</span></button>
                            <div id="dd-phase-1" class="hidden absolute left-0 mt-2 w-full bg-white border border-slate-200 rounded-md shadow-lg z-50"><div class="py-1">
                                <button onclick="addPresetQuestion('q-phase-1', 'Does the SFTP server require IP Allowlisting?')" class="block px-4 py-2 text-sm text-slate-700 hover:bg-blue-50 w-full text-left">IP Allowlisting?</button>
                                <button onclick="addCustomQuestion('q-phase-1')" class="block px-4 py-2 text-sm text-blue-600 font-bold hover:bg-blue-50 w-full text-left border-t">Write Custom Question...</button>
                            </div></div>
                        </div>
                        <div class="mt-4 border-t border-slate-200 pt-2">
                             <button onclick="addNote('q-phase-1')" class="text-xs text-slate-400 hover:text-slate-600 flex items-center"><span class="mr-1">+</span> Add Note</button>
                        </div>
                    </div>
                </div>
            </section>

            <div id="dynamic-workbench-container">
                </div>

            <section id="phase-4" class="scroll-mt-24 pt-12 border-t border-dashed border-slate-200 mt-12 pb-24 group" data-index="4">
                <div class="flex items-center mb-6">
                    <span class="bg-emerald-100 text-emerald-700 font-bold px-3 py-1 rounded text-sm mr-3">PHASE 4</span>
                    <h3 class="text-2xl font-bold text-slate-900">Bank Specification (Master List)</h3>
                </div>
                
                <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                    <div class="bg-slate-50 border-b border-slate-200 px-6 py-4 flex flex-wrap gap-2">
                        <button onclick="switchTab('summary')" id="btn-summary" class="tab-btn active px-4 py-2 rounded-lg text-sm font-bold transition shadow-sm">‚ö†Ô∏è Gaps</button>
                        <button onclick="switchTab('full')" id="btn-full" class="tab-btn px-4 py-2 rounded-lg text-sm font-bold transition shadow-sm">üìÑ Master Spec</button>
                        <button onclick="switchTab('visualizer')" id="btn-visualizer" class="tab-btn px-4 py-2 rounded-lg text-sm font-bold transition shadow-sm border-blue-200 text-blue-700 bg-blue-50">üñ®Ô∏è Visualizer</button>
                        <button onclick="switchTab('tags')" id="btn-tags" class="tab-btn px-4 py-2 rounded-lg text-sm font-bold transition shadow-sm">üè∑Ô∏è Tags</button>
                    </div>
                    
                    <div class="p-6">
                        <div id="view-summary" class="block">
                            <div class="bg-amber-50 border-l-4 border-amber-400 p-4 mb-4 flex justify-between items-center">
                                <h4 class="font-bold text-amber-900 text-sm">Automated Gaps Detected</h4>
                                <span class="text-amber-800 text-xs" id="gap-count"></span>
                            </div>
                            <div id="gaps-list" class="text-sm">
                                <p class="text-xs text-slate-500">No gaps detected yet.</p>
                            </div>
                        </div>
                        <div id="view-full" class="hidden">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-3">
                                    <input id="master-search" class="master-search" placeholder="Search FISPAN constant..." />
                                    <button id="master-toggle-wrap" class="text-sm px-3 py-1 border rounded text-slate-600">Wrap: <span id="master-wrap-state">off</span></button>
                                </div>
                                <div class="text-sm text-slate-500 ml-4">Total: <span id="master-count">0</span></div>
                            </div>
                            <table class="w-full text-left text-sm border-collapse">
                                <thead class="bg-slate-50 text-slate-700 font-bold">
                                    <tr>
                                        <th class="p-3 border-b bg-slate-100 w-1/3">FISPAN Constant</th>
                                        <th class="p-3 border-b bg-slate-100 w-1/6">Value Type</th>
                                        <th class="p-3 border-b bg-slate-100">Mapped Spec</th>
                                        <th class="p-3 border-b bg-slate-100">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="full-spec-body" class="divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                        <div id="view-visualizer" class="hidden">
                             <div class="check-face relative bg-blue-50 border-2 border-slate-300 rounded-md p-6 w-full max-w-3xl mx-auto shadow-md mb-6" style="aspect-ratio: 2.5/1;">
                                <div class="absolute top-6 left-6 text-xs check-field" data-tooltip="Row 23: Payer Name"><p class="font-bold">MYCOMPANY INC.</p></div>
                                <div class="absolute top-1/3 left-6 right-12 mt-6 flex items-end">
                                    <span class="text-xs font-bold uppercase mr-2">Pay To:</span>
                                    <div class="border-b border-slate-400 flex-grow pl-2 font-bold text-lg check-field" data-tooltip="Row 14: Payee Name">ACME CORP</div>
                                    <div class="ml-4 border border-slate-300 bg-white px-2 py-1 font-bold text-lg check-field" data-tooltip="Row 38: Amount">$500.00</div>
                                </div>
                                <div class="absolute top-6 left-1/2 transform -translate-x-1/2 text-center text-[10px] text-slate-400 check-field" data-tooltip="Row 33: Bank Name">CUSTOMERS BANK</div>
                            </div>
                            <div class="max-w-3xl mx-auto border-t border-slate-200 pt-4">
                                <h5 class="text-xs font-bold text-slate-500 uppercase mb-3">üìÅ Logic Data (Not Printed)</h5>
                                <div class="grid grid-cols-3 gap-3 text-xs">
                                    <div class="p-2 bg-slate-50 border rounded check-field" data-tooltip="Row 45: Delivery">Method: Mail</div>
                                </div>
                            </div>
                        </div>
                        <div id="view-tags" class="hidden">
                            <p class="text-xs text-slate-500">No assigned rows yet.</p>
                        </div>
                    </div>

                    <div class="pt-6 border-t border-slate-100 bg-slate-50/50 px-6 pb-6">
                        <div class="space-y-3" id="q-phase-4"></div>
                        <div class="mt-3 relative inline-block text-left w-full">
                            <button onclick="toggleDropdown('dd-phase-4')" class="flex items-center text-xs font-bold text-blue-600 hover:text-blue-800 transition bg-white border border-blue-200 px-3 py-2 rounded-lg shadow-sm w-full justify-between"><span>+ Add Scoping Question</span><span>‚ñº</span></button>
                            <div id="dd-phase-4" class="hidden absolute bottom-full mb-2 left-0 w-full bg-white border border-slate-200 rounded-md shadow-lg z-50"><div class="py-1"><button onclick="addCustomQuestion('q-phase-4')" class="block px-4 py-2 text-sm text-blue-600 font-bold hover:bg-blue-50 w-full text-left border-t">Write Custom Question...</button></div></div>
                        </div>
                        <div class="mt-4 border-t border-slate-200 pt-2">
                             <button onclick="addNote('q-phase-4')" class="text-xs text-slate-400 hover:text-slate-600 flex items-center"><span class="mr-1">+</span> Add Note</button>
                        </div>
                    </div>
                </div>
            </section>

        </div>
    </main>

    <aside class="w-80 bg-white border-l border-slate-200 flex-shrink-0 hidden xl:flex flex-col h-full shadow-lg z-30">
        <div class="p-6 border-b border-slate-100 flex justify-between items-center">
            <div>
                <h3 class="font-bold text-slate-800">Lifecycle Feed</h3>
                <p class="text-xs text-slate-500 mt-1">Granular Transaction Steps</p>
            </div>
            <label class="flex items-center cursor-pointer relative" title="Toggle Technical Context">
                <input type="checkbox" id="toggle-feed-context" class="sr-only">
                <div class="w-8 h-4 bg-slate-200 rounded-full shadow-inner"></div>
                <div class="dot absolute left-0 top-0 w-4 h-4 bg-white rounded-full shadow transition-transform duration-300"></div>
            </label>
        </div>
        <div class="flex-1 overflow-y-auto p-6 space-y-0 relative feed-container" id="feed-container">
            <div class="feed-item" data-phase="2">
                <div class="feed-dot"></div>
                <h4 class="text-sm font-bold text-slate-800">User Accesses Plugin</h4>
                <p class="text-xs text-slate-500 mt-1">Requests latest open bills from ERP GL.</p>
                <div class="feed-modal"><h5 class="font-bold text-xs text-blue-700 uppercase mb-2">Technical Context</h5><p class="text-xs text-slate-600 leading-relaxed">Plugin initiates `GET /vendor-bills` call to ERP API.</p></div>
            </div>
            <div class="feed-item" data-phase="2">
                <div class="feed-dot"></div>
                <h4 class="text-sm font-bold text-slate-800">Method Selection</h4>
                <p class="text-xs text-slate-500 mt-1">User selects "Check" via Dropdown.</p>
                <div class="feed-modal"><h5 class="font-bold text-xs text-blue-700 uppercase mb-2">Configuration</h5><p class="text-xs text-slate-600 leading-relaxed">Mapped to Bank Code: `CHK`.</p></div>
            </div>
             <div class="feed-item" data-phase="2">
                <div class="feed-dot"></div>
                <h4 class="text-sm font-bold text-slate-800">Submission & Auth</h4>
                <p class="text-xs text-slate-500 mt-1">Plugin creates record. FISPAN authenticates.</p>
            </div>
            <div class="feed-item" data-phase="3">
                <div class="feed-dot"></div>
                <h4 class="text-sm font-bold text-slate-800">Platform Validation</h4>
                <p class="text-xs text-slate-500 mt-1">Checks data against Customer File Spec.</p>
            </div>
            <div class="feed-item" data-phase="3">
                <div class="feed-dot"></div>
                <h4 class="text-sm font-bold text-slate-800">Transformation</h4>
                <p class="text-xs text-slate-500 mt-1">Formats valid requests into Bank CSV.</p>
            </div>
             <div class="feed-item" data-phase="3">
                <div class="feed-dot"></div>
                <h4 class="text-sm font-bold text-slate-800">Transmission</h4>
                <p class="text-xs text-slate-500 mt-1">Sends to Endpoint (SFTP/API).</p>
            </div>
             <div class="feed-item" data-phase="4">
                <div class="feed-dot"></div>
                <h4 class="text-sm font-bold text-slate-800">Bank Processing</h4>
                <p class="text-xs text-slate-500 mt-1">Bank parses file & executes payments.</p>
            </div>
             <div class="feed-item" data-phase="4">
                <div class="feed-dot"></div>
                <h4 class="text-sm font-bold text-slate-800">Status Updates</h4>
                <p class="text-xs text-slate-500 mt-1">Bank sends webhooks/ACKs back to FISPAN.</p>
                <div class="feed-modal"><h5 class="font-bold text-xs text-blue-700 uppercase mb-2">Webhook Payload</h5><p class="text-xs text-slate-600 leading-relaxed">Example payload: <code class="font-mono">{ paymentId, status, bankRef, errorCode }</code></p></div>
            </div>
            <div class="feed-item" data-phase="4">
                <div class="feed-dot"></div>
                <h4 class="text-sm font-bold text-slate-800">Reconciliation</h4>
                <p class="text-xs text-slate-500 mt-1">Bank feeds reconcile transactions in ERP.</p>
                <div class="feed-modal"><h5 class="font-bold text-xs text-blue-700 uppercase mb-2">Reconciliation Data</h5><p class="text-xs text-slate-600 leading-relaxed">Includes bank statement lines, settlement references.</p></div>
            </div>
        </div>
    </aside>

    <div id="export-modal" class="uploader-modal hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-8 relative">
            <button onclick="toggleExport()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">‚úï</button>
            <h3 class="text-xl font-bold text-slate-900 mb-2">Export Solution</h3>
            <p class="text-sm text-slate-500 mb-6">Choose an export format for your current mapping configuration.</p>
            <div class="space-y-4">
                <div class="p-4 border rounded-lg hover:bg-slate-50 cursor-pointer flex items-center justify-between group" onclick="copyToClipboardHTML()">
                    <div class="flex items-center gap-3">
                        <div class="bg-blue-100 text-blue-600 w-10 h-10 rounded-full flex items-center justify-center text-xl">üìã</div>
                        <div><h4 class="font-bold text-slate-800">Copy to Clipboard</h4><p class="text-xs text-slate-500">Best for pasting into Confluence, Excel, or Google Sheets.</p></div>
                    </div>
                    <span class="text-blue-600 opacity-0 group-hover:opacity-100 transition font-bold text-sm">Copy &rarr;</span>
                </div>
                <div class="p-4 border rounded-lg hover:bg-slate-50 cursor-pointer flex items-center justify-between group" onclick="downloadCSV()">
                    <div class="flex items-center gap-3">
                        <div class="bg-emerald-100 text-emerald-600 w-10 h-10 rounded-full flex items-center justify-center text-xl">üìä</div>
                        <div><h4 class="font-bold text-slate-800">Download CSV</h4><p class="text-xs text-slate-500">Raw data file for data analysis or migration.</p></div>
                    </div>
                    <span class="text-emerald-600 opacity-0 group-hover:opacity-100 transition font-bold text-sm">Download &rarr;</span>
                </div>
            </div>
        </div>
    </div>

    <div id="uploader-modal" class="uploader-modal hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl p-8 relative"> <button onclick="toggleUploader()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">‚úï</button>
            <h3 class="text-xl font-bold text-slate-900 mb-2">Upload Bank Specification</h3>
            <p class="text-sm text-slate-500 mb-6">Upload a CSV or Paste Rows to begin the assignment process.</p>
                <div id="drag-zone-modal" class="border-2 border-dashed border-slate-200 rounded-lg p-8 text-center hover:bg-slate-50 transition cursor-pointer drag-zone">
                <div class="text-4xl mb-2">üìÑ</div>
                <p class="text-sm font-medium text-slate-700">Drag & Drop CSV here</p>
            </div>
                <div class="mt-3 text-center">
                    <input id="csv-file-input" type="file" accept="text/csv,.csv" class="hidden">
                    <button id="btn-upload-csv" class="text-sm bg-blue-600 text-white px-3 py-2 rounded-md">Upload CSV</button>
                </div>
        </div>
    </div>

    <div id="const-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4" role="dialog" aria-modal="true">
            <div class="p-4 border-b flex justify-between items-start">
                <div>
                    <h4 id="const-modal-title" class="font-bold text-slate-800">Constant</h4>
                    <p id="const-modal-sub" class="text-xs text-slate-500 mt-1">Value Type</p>
                </div>
                <div class="flex items-center gap-2">
                    <button id="const-copy-key" class="text-sm text-blue-600">Copy Key</button>
                    <button onclick="closeConstModal()" class="text-sm text-slate-500">Close</button>
                </div>
            </div>
            <div class="p-4">
                <div id="const-modal-desc" class="text-sm text-slate-700 leading-relaxed"></div>
            </div>
        </div>
    </div>

    <div id="row-question-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4" role="dialog" aria-modal="true">
            <div class="p-4 border-b flex justify-between items-start bg-slate-50 rounded-t-lg">
                <h4 class="font-bold text-slate-800">Row Question</h4>
                <button onclick="closeRowQuestionModal()" class="text-sm text-slate-400 hover:text-slate-600">‚úï</button>
            </div>
            <div class="p-6" id="row-question-container">
                </div>
        </div>
    </div>

    <script src="assets/js/app.js"></script>
</body>
</html>